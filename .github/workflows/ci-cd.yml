name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_REPO }}
  K8S_NAMESPACE: ecommerce

jobs:
  # Job 1: Build và test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build

  # Job 2: Build và push Docker image
  build-and-push:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_REPO }}
        tags: |
          type=sha,prefix=v,format=short
          type=ref,event=branch
          latest
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Generate Docker tag
      id: tag
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        DATE=$(date +'%Y%m%d')
        echo "tag=v${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "TAG=v${DATE}-${SHORT_SHA}"
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_REPO }}:${{ steps.tag.outputs.tag }}
          ${{ secrets.DOCKER_REPO }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # # Job 3: Deploy lên Kubernetes
  # deploy-k8s:
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
    
  #   - name: Set up kubectl
  #     uses: azure/setup-kubectl@v3
  #     with:
  #       version: 'latest'
    
  #   - name: Configure kubeconfig
  #     run: |
  #       mkdir -p ~/.kube
  #       echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > ~/.kube/config
  #       chmod 600 ~/.kube/config
        
  #       # Test connection
  #       kubectl cluster-info
  #       kubectl get nodes
    
  #   - name: Update deployment with new image
  #     run: |
  #       # Tạo file deployment mới với image tag mới
  #       sed "s|caramensuachua/ecommerce-frontend:v1|${{ secrets.DOCKER_REPO }}:${{ needs.build-and-push.outputs.image_tag }}|g" deployment-fe.yaml > deployment-fe-new.yaml
        
  #       # Apply deployment
  #       kubectl apply -f deployment-fe-new.yaml
        
  #       # Hoặc dùng kubectl set image
  #       kubectl set image deployment/ecommerce-frontend-deployment \
  #         ecommerce-frontend=${{ secrets.DOCKER_REPO }}:${{ needs.build-and-push.outputs.image_tag }} \
  #         --record
    
  #   - name: Verify deployment
  #     run: |
  #       echo "Waiting for rollout to complete..."
  #       kubectl rollout status deployment/ecommerce-frontend-deployment --timeout=300s
        
  #       echo "Current deployment status:"
  #       kubectl get deployment ecommerce-frontend-deployment -o wide
        
  #       echo "Pods status:"
  #       kubectl get pods -l app=ecommerce-frontend

  # # Job 4: Deploy via Rancher (optional)
  # deploy-rancher:
    # runs-on: ubuntu-latest
    # needs: build-and-push
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # steps:
    # - name: Install Rancher CLI
    #   run: |
    #     wget -q https://github.com/rancher/cli/releases/download/v2.7.0/rancher-linux-amd64-v2.7.0.tar.gz
    #     tar -xzf rancher-linux-amd64-v2.7.0.tar.gz
    #     sudo mv rancher-v2.7.0/rancher /usr/local/bin/
    #     rancher --version
    
    # - name: Login to Rancher
    #   run: |
    #     rancher login ${{ secrets.RANCHER_URL }} \
    #       --token ${{ secrets.RANCHER_TOKEN }}
        
    #     # List clusters
    #     rancher clusters ls
    
    # - name: Deploy using Rancher
    #   run: |
    #     # Chuyển context sang cluster mong muốn
    #     rancher context switch <your-cluster-id>
        
    #     # Update image trong deployment
    #     rancher kubectl set image deployment/ecommerce-frontend-deployment \
    #       ecommerce-frontend=${{ secrets.DOCKER_REPO }}:${{ needs.build-and-push.outputs.image_tag }}
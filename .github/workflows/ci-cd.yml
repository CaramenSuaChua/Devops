name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_REPO }}
  K8S_NAMESPACE: ecommerce

jobs:
  # PR: SonarQube Analysis + Quality Gate
  analyze:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

    - name: Test SonarQube Connection
      run: |
        echo "Testing connection to SonarQube.11211.."
        
        # Test 1: Basic connectivity
        echo "1. Testing basic connectivity..."
        if curl -s -o /dev/null -w "%{http_code}" "${{ secrets.SONAR_HOST_URL }}/api/system/status" | grep -q "200"; then
          echo "✅ SonarQube is reachable"
        else
          echo "❌ Cannot reach SonarQube at ${{ secrets.SONAR_HOST_URL }}"
          echo "Trying with verbose output..."
          curl -v "${{ secrets.SONAR_HOST_URL }}" || true
          exit 1
        fi
        
        # Test 2: API version endpoint
        echo "2. Testing API version endpoint..."
        curl -s "${{ secrets.SONAR_HOST_URL }}/api/server/version" && echo ""
        
        # Test 3: With token
        echo "3. Testing with authentication token..."
        curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
          "${{ secrets.SONAR_HOST_URL }}/api/system/status" | jq '.status,.version' || echo "Token authentication failed"
    
    # - name: Install dependencies
    #   run: npm ci
  
    # - name: Run tests with coverage
    #   run: npm run test:ci
    
    # - name: SonarQube Scan
    #   uses: SonarSource/sonarqube-scan-action@master
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    
    # - name: Check Quality Gate
    #   uses: SonarSource/sonarqube-quality-gate-action@master
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  # Job 1: Build và test
  # build-and-test:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
    
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: '18'
  #       cache: 'npm'
    
  #   - name: Install dependencies
  #     run: npm ci
    
  #   - name: Build application
  #     run: npm run build

  # Job 2: Build và push Docker image
  # build-and-push:
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
  #   outputs:
  #     image_tag: ${{ steps.tag.outputs.tag }}
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
    
  #   - name: Extract metadata for Docker
  #     id: meta
  #     uses: docker/metadata-action@v5
  #     with:
  #       images: ${{ secrets.DOCKER_REPO }}
  #       tags: |
  #         type=sha,prefix=v,format=short
  #         type=ref,event=branch
  #         latest
    
  #   - name: Set up Docker Buildx
  #     uses: docker/setup-buildx-action@v3
    
  #   - name: Login to DockerHub
  #     uses: docker/login-action@v3
  #     with:
  #       username: ${{ secrets.DOCKER_USERNAME }}
  #       password: ${{ secrets.DOCKER_PASSWORD }}

  #   - name: Get PR number from commit message
  #     id: pr-number
  #     run: |
  #       # Lấy PR number từ commit message (khi merge với squash/sử dụng conventional commits)
  #       PR_NUMBER=$(git log -1 --pretty=%B | grep -o '#[0-9]*' | head -1 | tr -d '#' || echo "")
        
  #       if [ -z "$PR_NUMBER" ]; then
  #         # Hoặc tìm trong merge commit
  #         PR_NUMBER=$(git log -1 --pretty=%B | grep -o 'Merge pull request #[0-9]*' | grep -o '[0-9]*' || echo "")
  #       fi
        
  #       if [ -z "$PR_NUMBER" ]; then
  #         # Fallback: dùng commit SHA
  #         PR_NUMBER="sha-$(echo ${{ github.sha }} | cut -c1-7)"
  #       fi
        
  #       echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
  #       echo "PR number: $PR_NUMBER"
    
  #   - name: Generate Docker tag
  #     id: tag
  #     run: |
  #       SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
  #       DATE=$(date +'%Y%m%d')
  #       echo "tag=v${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT
  #       echo "TAG=v${DATE}-${SHORT_SHA}"
    
  #   - name: Build and push Docker image
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: .
  #       push: true
  #       tags: |
  #         ${{ secrets.DOCKER_REPO }}:v${{ steps.pr-number.outputs.PR_NUMBER }}
  #       cache-from: type=gha
  #       cache-to: type=gha,mode=max

  # # Job 3: Deploy lên Kubernetes
  # deploy-k8s:
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
    
  #   - name: Set up kubectl
  #     uses: azure/setup-kubectl@v3
  #     with:
  #       version: 'latest'
    
  #   - name: Configure kubeconfig
  #     run: |
  #       mkdir -p ~/.kube
  #       echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > ~/.kube/config
  #       chmod 600 ~/.kube/config
        
  #       # Test connection
  #       kubectl cluster-info
  #       kubectl get nodes
    
  #   - name: Update deployment with new image
  #     run: |
  #       # Tạo file deployment mới với image tag mới
  #       sed "s|caramensuachua/ecommerce-frontend:v1|${{ secrets.DOCKER_REPO }}:${{ needs.build-and-push.outputs.image_tag }}|g" deployment-fe.yaml > deployment-fe-new.yaml
        
  #       # Apply deployment
  #       kubectl apply -f deployment-fe-new.yaml
        
  #       # Hoặc dùng kubectl set image
  #       kubectl set image deployment/ecommerce-frontend-deployment \
  #         ecommerce-frontend=${{ secrets.DOCKER_REPO }}:${{ needs.build-and-push.outputs.image_tag }} \
  #         --record
    
  #   - name: Verify deployment
  #     run: |
  #       echo "Waiting for rollout to complete..."
  #       kubectl rollout status deployment/ecommerce-frontend-deployment --timeout=300s
        
  #       echo "Current deployment status:"
  #       kubectl get deployment ecommerce-frontend-deployment -o wide
        
  #       echo "Pods status:"
  #       kubectl get pods -l app=ecommerce-frontend

  # # Job 4: Deploy via Rancher (optional)
  # deploy-rancher:
    # runs-on: ubuntu-latest
    # needs: build-and-push
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # steps:
    # - name: Install Rancher CLI
    #   run: |
    #     wget -q https://github.com/rancher/cli/releases/download/v2.7.0/rancher-linux-amd64-v2.7.0.tar.gz
    #     tar -xzf rancher-linux-amd64-v2.7.0.tar.gz
    #     sudo mv rancher-v2.7.0/rancher /usr/local/bin/
    #     rancher --version
    
    # - name: Login to Rancher
    #   run: |
    #     rancher login ${{ secrets.RANCHER_URL }} \
    #       --token ${{ secrets.RANCHER_TOKEN }}
        
    #     # List clusters
    #     rancher clusters ls
    
    # - name: Deploy using Rancher
    #   run: |
    #     # Chuyển context sang cluster mong muốn
    #     rancher context switch <your-cluster-id>
        
    #     # Update image trong deployment
    #     rancher kubectl set image deployment/ecommerce-frontend-deployment \
    #       ecommerce-frontend=${{ secrets.DOCKER_REPO }}:${{ needs.build-and-push.outputs.image_tag }}